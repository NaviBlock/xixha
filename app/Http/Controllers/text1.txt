<?php

namespace prueba\Http\Controllers;

use Illuminate\Http\Request;
 
use prueba\Http\Requests;
use Illuminate\Support\Facades\Redirect;
use Illuminate\Support\Facades\Input;
use prueba\Http\Requests\VentaFormRequest;

//Agregando modelos
use prueba\Venta; 
use prueba\DetalleVenta;

use DB;

use Carbon\Carbon;
use Response;
use Illuminate\Support\Collection;


class VentaController extends Controller
{
    
 public function __construc(){


    }

public function index(Request $request)
    {
         if ($request)
        {
            $query=trim($request->get('searchText'));
            
            $ventas=DB::table('venta  as v')
            ->join('persona as p','v.idcliente','=','p.idpersona')
            ->join('detalle_venta as dv','v.idventa','=','dv.idventa')
            ->select('v.idventa','v.fecha_hora','p.nombre','v.tipo_comprobante','v.serie_comprobante','v.num_comprobante','v.impuesto','v.estado','v.total_venta')
            ->where('v.num_comprobante','LIKE','%'.$query.'%')

           ->orderBy('v.idventa','desc')
           ->groupBy('v.idventa','v.fecha_hora','p.nombre','v.tipo_comprobante','v.serie_comprobante','v.num_comprobante','v.impuesto','v.estado')
            ->paginate(7);
            return view('ventas.venta.index',["ventas"=>$ventas,"searchText"=>$query]);
        }
    }

  
   public function create()
    {
$personas=DB::table('persona')->where('tipo_persona','=','Cliente')->get();
$articulos=DB::table('articulo as art')
->join('detalle_ingreso as di','art.idarticulo','=','di.idarticulo')
->select(DB::raw('CONCAT(art.codigo, " ",art.nombre) AS articulo'),'art.idarticulo','art.stock',DB::raw('avg(di.precio_venta) as precio_promedio'))

->where('art.estado','=','Activo')
->where('art.stock','>','0')
->groupBy('articulo','art.idarticulo','art.stock')
->get();
   return view("ventas.venta.create",["personas"=>$personas,"articulos"=>$articulos]);
   }

    public function store(VentaFormRequest $request)
        {
         try{
        DB::beginTransaction();
        $venta=new Venta;
        $venta->idcliente=$request->get('idcliente');
        $venta->tipo_comprobante=$request->get('tipo_comprobante');
        $venta->serie_comprobante=$request->get('serie_comprobante');
        $venta->num_comprobante=$request->get('num_comprobante');
        $venta->total_venta=$request->get('total_venta');
        
        $mytime=Carbon::now('America/Guayaquil');
        $venta->fecha_hora=$mytime->toDateTimeString();
        $venta->impuesto='18';
        $venta->estado='A';
        $venta->save();

        $idarticulo =$request->get('idarticulo');
        $cantidad =$request->get('cantidad');
        $descuento =$request->get('descuento');
        $precio_venta =$request->get('precio_venta');

        $cont =0;

        while ($cont < count($idarticulo)) {

            $detalle = new DetalleVenta();

            $detalle->idventa= $venta->idventa;
            $detalle->idarticulo= $idarticulo[$cont];
            $detalle->cantidad= $cantidad[$cont];
            $detalle->descuento= $descuento[$cont];
            $detalle->precio_venta= $precio_venta[$cont];
            $detalle->save();
            $cont=$cont+1;
              
             }


        DB::commit();

        }catch(Exception $e){

        DB::roolback();

        }

    return Redirect::to('ventas/venta');

     }



     public function show($id)
    {

        $venta= DB::table('venta as v')
            ->join('persona as p','v.idcliente','=','p.idpersona')
            ->join('detalle_venta as dv','v.idventa','=','dv.idventa')
            ->select('v.idventa','v.fecha_hora','p.nombre','v.tipo_comprobante','v.serie_comprobante','v.num_comprobante','v.impuesto','v.estado','v.total_venta')
            ->where('v.idventa','=',$id)
            ->first();
                    
        $detalles=DB::table('detalle_venta as d')
            ->join('articulo as a','d.idarticulo','=','a.idarticulo')
            ->select('a.nombre as articulo','d.cantidad','d.descuento','d.precio_venta')
            ->where('d.idventa','=',$id)
            ->get();

        return view("ventas.venta.show", ["venta"=>$venta,"detalles"=>$detalles]);

}

   public function destroy($id)
    {
        $venta=Venta::findOrFail($id);
        $venta->Estado='C';
        $venta->update();
        return Redirect::to('ventas/venta');
    }

}

>>>SHOW.BLADE.PHP
@extends ('layouts.admin')
@section ('contenido')
 
<div class="row">
                
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                 <div class="form-group">
                <label for="cliente">Cliente</label>
                <p>{{$venta->nombre}}</p>
               
            </div>
            </div>

             <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                <div class="form-group">
                <label>Tipo Comprobante</label>
                   <p>{{$venta->tipo_comprobante}}</p>
            
            </div>
            </div>
            
            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                 <div class="form-group">
                <label for="serie_comprobante">Serie Comprobante</label>
                   <p>{{$venta->serie_comprobante}}</p>
            </div>
            </div>

            <div class="col-lg-4 col-md-4 col-sm-4  col-xs-12">
                <div class="form-group">
                <label for="stock">Número Comprobante</label>
                  <p>{{$venta->num_comprobante}}</p>

            </div>
            </div>

    </div>
                    
            <div class="row">
            <div class="panel panel-primary">
            <div class="panel-body">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <table id="detalles" class="table table-striped table-bordered table-condensed table-hover">
                <thead style="background-color:#A9D0F5">
                    <th>Artículos</th>
                    <th>Cantidad</th>
                    <th>Precio Venta</th>
                    <th>Descuento</th>
                    <th>Subtotal</th>
                 </thead>
                    <tfoot>
                 
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th><h4 id="total">{{$venta->total_venta}}</h4></th> 

                </tfoot>
                <tbody>
                    @foreach($detalles as $det)
                    <tr>
                        <td>{{$det->articulo}}</td>
                        <td>{{$det->cantidad}}</td>
                        <td>{{$det->precio_venta}}</td>
                        <td>{{$det->descuento}}</td>
                        <td>{{$det->cantidad*$det->precio_venta-$det->descuento}}</td>

                    </tr>
                    @endforeach
                </tbody>
                </table>
                    
                </div>
              </div>
                
            </div>
         </div>
  @endsection
 
CREATE TRIGGER tr_updStockAnularVenta AFTER UPDATE ON venta 
FOR EACH ROW 
 update articulo a
    join detalleventa di
      on di.Id_Articulo = a.Id_Articulo
     and di.IdVenta = new.IdVenta
     set a.stock = a.stock + di.cantidad;﻿

para el problema del stock
    cantidad = parseInt($("#cantidadVenta").val())
      stock = parseInt($("#pstock").val());



---------------------
CREATE TRIGGER `tr_uppStockCompraAnulada` AFTER UPDATE ON `compra`
 FOR EACH ROW BEGIN 
 UPDATE producto 
    INNER JOIN detallecompra
     ON detallecompra.idProductoDetalleCompra = producto.idProducto
     INNER JOIN compra
     ON detallecompra.idCompraDetalleCompra = NEW.idCompra
     SET producto.stockProducto = producto.stockProducto - detallecompra.cantidadProductoAbastecido;
     END

CREATE TRIGGER `tr_uppStockVentaAnulada` AFTER UPDATE ON `venta`
 FOR EACH ROW BEGIN 
 UPDATE producto 
    INNER JOIN detalleventa
     ON detalleventa.idProductoDetalleVenta = producto.idProducto
     INNER JOIN venta
     ON detalleventa.idVentaDetalleVenta = NEW.idVenta
     SET producto.stockProducto = producto.stockProducto + detalleventa.cantidadProductoVenta;
     END



     ------------------
     function agregar() 
    {
        datosArticulo = document.getElementById('pidarticulo').value.split('_');
        
        idarticulo = datosArticulo[0];
        articulo = $("#pidarticulo option:selected").text();
        cantidad = parseInt($("#pcantidad").val());
        descuento = $("#pdescuento").val();
        precio_venta = $("#pprecio_venta").val();
        stock = parseInt($("#pstock").val());
        //alert("cant/stock"+cantidad+"/"+stock);
        if (idarticulo!="" && cantidad!="" && cantidad>0 && precio_venta!="" && descuento!="")
        {
            if (stock>=cantidad)
            {
                subtotal[cont] = (cantidad*precio_venta-descuento);
                total = total + subtotal[cont];

                var fila = '<tr class="selected" id="fila'+cont+'"><td><button type="button" class="btn btn-warning" onclick="eliminar('+cont+');">X</button></td><td><input type="hidden" name="idarticulo[]" value="'+idarticulo+'">'+articulo+'</td><td><input type="number" name="cantidad[]" value="'+cantidad+'"></td><td><input type="number" name="precio_venta[]" value="'+precio_venta+'"></td><td><input type="number" name="descuento[]" value="'+descuento+'"></td><td>'+subtotal[cont]+'</td></tr>';
                cont++;
                limpiar();

                $("#total").html("$ "+total);
                $("#total_venta").val(total);
                evaluar();
                $('#detalles').append(fila);
            }
            else
            {
                alert("El total a vender no debe superar el stock.");
            }
            
            
        }
        else
        {
            alert("Error al ingresar el detalle de la venta, revise los datos del artículo");
        }
    }﻿




    -------------------------
    @extends ('layouts.admin')
@section ('contenido')
<div class="row">
 <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
  <h3>Nuevo Venta</h3>
  @if (count($errors)>0)
  <div class="alert alert-danger">
   <ul>
    @foreach ($errors->all() as $error)
    <li>{{$error}}</li>
    @endforeach
   </ul>
  </div>
  @endif
 </div>
</div>
{!!Form::open(array('url'=>'ventas/venta','method'=>'POST','autocomplete'=>'off'))!!}
{{Form::token()}}
<div class="row">
 <div class="col-lg-12 col-sm-12 col-md-12 col-xs-12">
  <div class="form-group">
   <label for="cliente">Cliente</label>
   <select name="idcliente"  id="idcliente" class="form-control selectpicker" data-live-search="true">
    @foreach($personas as $persona)
    <option value="{{$persona->idpersona}}">{{$persona->nombre}}</option>
    @endforeach
   </select>
  </div>
 </div>
 <div class="col-lg-4 col-sm-4 col-md-4 col-xs-12">
  <div class="form-group">
   <label>Tipo Comprobante</label>
   <select name="tipo_comprobante" class="form-control">
    <option value="Boleta">Boleta</option>
    <option value="Factura">Factura</option>
    <option value="Ticket">Ticket</option>
   </select>
  </div>
 </div>
 <div class="col-lg-4 col-sm-4 col-md-4 col-xs-12">
  <div class="form-group">
   <label for="serie_comprobante">Serie comprobante</label>
   <input type="text" name="serie_comprobante" value="{{old('serie_comprobante')}}" class="form-control" placeholder="Serie comprobante...">
  </div>
 </div>
 <div class="col-lg-4 col-sm-4 col-md-4 col-xs-12">
  <div class="form-group">
   <label for="num_comprobante">Número comprobante</label>
   <input type="text" name="num_comprobante" required value="{{old('num_comprobante')}}" class="form-control" placeholder="Número comprobante...">
  </div>
 </div>
</div>
<div class="row">
 <div class="panel panel-primary">
  <div class="panel-body">
   <div class="col-lg-4 col-sm-4 col-md-4 col-xs-12">
    <div class="form-group">
     <label>Artículo</label>
     <select name="pidarticulo" class="form-control selectpicker" id="pidarticulo" data-live-search="true">
      @foreach($articulos as $articulo)
      <option value="{{$articulo->idarticulo}}_{{$articulo->stock}}_{{$articulo->precio_promedio}}">{{$articulo->articulo}}</option>
      @endforeach
     </select>
    </div>
   </div>
   <div class="col-lg-2 col-sm-2 col-md-2 col-xs-12">
    <div class="form-group">
     <label for="cantidad">Cantidad</label>
     <input type="number" name="pcantidad" id="pcantidad" class="form-control" placeholder="cantidad">
    </div>
   </div>
   <div class="col-lg-2 col-sm-2 col-md-2 col-xs-12">
    <div class="form-group">
     <label for="stock">Stock</label>
     <input type="number" disabled name="pstock" id="pstock" class="form-control" placeholder="stock">
    </div>
   </div>
   <div class="col-lg-2 col-sm-2 col-md-2 col-xs-12">
    <div class="form-group">
     <label for="precio_venta">Precio venta</label>
     <input type="number" disabled name="pprecio_venta" id="pprecio_venta" class="form-control" placeholder="P. venta">
    </div>
   </div>
   <div class="col-lg-2 col-sm-2 col-md-2 col-xs-12">
    <div class="form-group">
     <label for="descuento">Descuento</label>
     <input type="number" name="pdescuento" id="pdescuento" class="form-control" placeholder="P. compra">
    </div>
   </div>
   <div class="col-lg-2 col-sm-2 col-md-2 col-xs-12">
    <div class="form-group">
     <button type="button" id="bt_add" class="btn btn-primary">Agregar</button>
    </div>
   </div>
   <div class="col-lg-12 col-sm-12 col-md-12 col-xs-12">
    <table id="detalles" class="table table-striped table-bordered table-condensed table-hover">
     <thead style="background-color:#A9D0F5">
      <th>Opciones</th>
      <th>Artículo</th>
      <th>Cantidad</th>
      <th>Precio Venta</th>
      <th>Descuento</th>
      <th>Subtotal</th>
     </thead>
     <tfoot>
      <th>TOTAL</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th><h4 id="total">S./ 0.00</h4><input type="hidden" name="total_venta" id="total_venta"></th>
     </tfoot>
     <tbody>

     </tbody>
    </table>
   </div>
  </div>
 </div>
 <div class="col-lg-6 col-sm-6 col-md-6 col-xs-12" id="guardar">
  <div class="form-group">
   <input name="_token" value="{{ csrf_token() }}" type="hidden"></input>
   <button class="btn btn-primary" type="submit">Guardar</button>
   <button class="btn btn-danger" type="reset">Cancelar</button>
  </div>
 </div>
</div>
{!!Form::close()!!}
@push('scripts')
<script>
$(document).ready(function(){
 $('#bt_add').click(function(){
  agregar();
 });
});

var cont = 0;
total = 0;
subtotal = [];
$("#guardar").hide();
$("#pidarticulo").change(mostrarValores);

function mostrarValores()
{
 datosArticulo=document.getElementById('pidarticulo').value.split('_');
 $("#pprecio_venta").val(datosArticulo[2]);
 $("#pstock").val(datosArticulo[1]);
}

function agregar()
{
 datosArticulo=document.getElementById('pidarticulo').value.split('_');

 idarticulo=datosArticulo[0];
 articulo=$("#pidarticulo option:selected").text();
 cantidad=$("#pcantidad").val();

 descuento=$("#pdescuento").val();
 precio_venta=$("#pprecio_venta").val();
 stock=$("#pstock").val();

 if (idarticulo!="" && cantidad!="" && cantidad>0 && descuento!="" && precio_venta!="")
 {
  if (stock >= cantidad)
  {
   subtotal[cont]=(cantidad * precio_venta - descuento);
   total=total + subtotal[cont];

   var fila='<tr class="selected" id="fila'+cont+'"><td><button type="button" class="btn btn-warning" onclick="eliminar('+cont+');">X</button></td><td><input type="hidden" name="idarticulo[]" value="'+idarticulo+'">'+articulo+'</td><td><input type="number" name="cantidad[]" value="'+cantidad+'"></td><td><input type="number" name="precio_venta[]" value="'+precio_venta+'"></td><td><input type="number" name="descuento[]" value="'+descuento+'"></td><td>'+subtotal[cont]+'</td></tr>';
   cont++;
   limpiar();
   $("#total").html("S./ " + total);
   $("#total_venta").val(total);
   evaluar();
   $('#detalles').append(fila);
  }
  else
  {
   alert('La cantidad a vender supera el stock');
  }
 }
 else
 {
  alert("Error al ingresar el detalle de la venta, revise los datos del articulo");
 }
}
function limpiar()
{
 $("#pcantidad").val("");
 $("#pdescuento").val("");
 $("#pprecio_venta").val("");
}
function evaluar()
{
 if (total > 0)
 {
  $("#guardar").show();
 }
 else
 {
  $("#guardar").hide();
 }
}
function eliminar(index)
{
 total=total - subtotal[index];
 $("#total").html("S./ " + total);
 $("#total_venta").val(total);
 $("#fila" + index).remove();
 evaluar();
}

</script>
@endpush
@endsection


-----------------------
if (stock >= cantidad)
ahora si permite agregar correctamente las cantidades si el stock lo supera o no intenten modificarlo no es un bug﻿


-------------------
JavaScript almacena en String las variables que toma de los campos de tipo text, lo conveniente seria parsear los datos a enteros para poder evaluarlos algo como stock = parseInt($("#pstock").val()) y así con cantidad﻿